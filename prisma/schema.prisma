generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── USER & AUTH ───────────────────────────────────────

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  passwordHash   String?
  role           String    @default("MEMBER") // ADMIN | MEMBER
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  accounts       Account[]
  sessions       Session[]

  createdPrograms    Program[]      @relation("ProgramCreatedBy")
  createdWorkstreams Workstream[]   @relation("WorkstreamCreatedBy")
  createdInitiatives Initiative[]   @relation("InitiativeCreatedBy")
  createdMilestones  Milestone[]    @relation("MilestoneCreatedBy")
  createdPartners    Partner[]      @relation("PartnerCreatedBy")
  personProfile      Person?
  assignments        Assignment[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── PROGRAM ───────────────────────────────────────────

model Program {
  id              String   @id @default(cuid())
  name            String   // "Project Neuron"
  mission         String?  // rich text
  vision          String?  // rich text
  successTenets   String?  // rich text
  objectives      String?  // rich text
  fyStartYear     Int      @default(26)
  fyEndYear       Int      @default(28)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdById     String?

  createdBy       User?        @relation("ProgramCreatedBy", fields: [createdById], references: [id])
  workstreams     Workstream[]
}

// ─── WORKSTREAM ────────────────────────────────────────

model Workstream {
  id                   String    @id @default(cuid())
  programId            String
  name                 String    // display name
  slug                 String    // URL-safe key: connectors, kit-applications, etc.
  description          String?
  targetCompletionDate String?   // e.g. "November 2027"
  status               String    @default("IN_PROGRESS") // NOT_STARTED | IN_PROGRESS | DONE
  sortOrder            Int       @default(0)
  color                String?   // hex color for Gantt bars

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  createdById          String?

  program              Program   @relation(fields: [programId], references: [id], onDelete: Cascade)
  createdBy            User?     @relation("WorkstreamCreatedBy", fields: [createdById], references: [id])
  initiatives          Initiative[]
  partnerLinks         PartnerWorkstream[]
  openIssues           OpenIssue[]
}

// ─── INITIATIVE ────────────────────────────────────────

model Initiative {
  id                String    @id @default(cuid())
  workstreamId      String
  name              String
  description       String?
  category          String    @default("TOOLING")
  // CONNECTOR | KIT_APP | PORTAL | AI_SYSTEM | INFRA | DEVSECOPS | ROBOTICS | TOOLING
  plannedStartMonth String?   // YYYY-MM
  plannedEndMonth   String?   // YYYY-MM
  status            String    @default("NOT_STARTED")
  // NOT_STARTED | IN_PROGRESS | BLOCKED | DONE
  tags              String?   // comma-separated
  ownerInitials     String?   // e.g. "DQ", "JC", "AB" from PDF
  needsRefinement   Boolean   @default(false)
  sortOrder         Int       @default(0)

  archivedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  createdById       String?

  workstream        Workstream @relation(fields: [workstreamId], references: [id], onDelete: Cascade)
  createdBy         User?      @relation("InitiativeCreatedBy", fields: [createdById], references: [id])

  totalPoints       Int       @default(0) // total story points for this initiative

  milestones        Milestone[]
  partnerLinks      PartnerInitiative[]
  artifacts         Artifact[]
  assignments       Assignment[]
  subTasks          SubTask[]

  // Dependencies (many-to-many self)
  dependsOn         InitiativeDependency[] @relation("DependsOn")
  dependedBy        InitiativeDependency[] @relation("DependedBy")
}

// ─── SUB-TASK ─────────────────────────────────────────

model SubTask {
  id                String    @id @default(cuid())
  initiativeId      String
  name              String
  description       String?
  points            Int       @default(0)
  completionPercent Int       @default(0) // 0–100
  status            String    @default("NOT_STARTED") // NOT_STARTED | IN_PROGRESS | DONE
  sortOrder         Int       @default(0)

  // Story-point estimation inputs
  estimatedDays     Float?    // estimated effort in days
  unknowns          String?   // None | Low | Low–Moderate | High | Very High / Exploratory
  integration       String?   // Single system | 1–2 systems | Multiple internal systems | Cross-team / external dependency
  isAddedScope      Boolean   @default(false) // true = effort added after initial plan

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  initiative        Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  openIssues        OpenIssue[]
}

// ─── OPEN ISSUE ──────────────────────────────────────

model OpenIssue {
  id              String    @id @default(cuid())
  workstreamId    String
  subTaskId       String?   // optional: the subtask this issue blocks
  title           String
  description     String?
  severity        String    @default("NOT_A_CONCERN") // STOPPING | SLOWING | NOT_A_CONCERN
  screenshotUrl   String?   // path or data-URL for uploaded screenshot
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  resolvedAt      DateTime? // null = open

  workstream      Workstream @relation(fields: [workstreamId], references: [id], onDelete: Cascade)
  subTask         SubTask?   @relation(fields: [subTaskId], references: [id], onDelete: SetNull)
  comments        IssueComment[]
}

// ─── ISSUE COMMENT ─────────────────────────────────

model IssueComment {
  id          String    @id @default(cuid())
  issueId     String
  body        String    // the comment text
  authorName  String?   // optional: who wrote it
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  issue       OpenIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)
}

model InitiativeDependency {
  id              String @id @default(cuid())
  initiativeId    String
  dependsOnId     String

  initiative      Initiative @relation("DependsOn", fields: [initiativeId], references: [id], onDelete: Cascade)
  dependsOn       Initiative @relation("DependedBy", fields: [dependsOnId], references: [id], onDelete: Cascade)

  @@unique([initiativeId, dependsOnId])
}

// ─── MILESTONE ─────────────────────────────────────────

model Milestone {
  id            String    @id @default(cuid())
  initiativeId  String?
  programId     String?   // for program-level milestones
  name          String
  date          String?   // YYYY-MM
  dateEnd       String?   // optional end for ranges
  notes         String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdById   String?

  initiative    Initiative? @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  createdBy     User?       @relation("MilestoneCreatedBy", fields: [createdById], references: [id])
}

// ─── PARTNER ───────────────────────────────────────────

model Partner {
  id              String    @id @default(cuid())
  name            String
  roleDescription String?
  agreements      String?
  logoUrl         String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdById     String?

  createdBy       User?     @relation("PartnerCreatedBy", fields: [createdById], references: [id])
  workstreamLinks PartnerWorkstream[]
  initiativeLinks PartnerInitiative[]
  artifacts       Artifact[]
}

model PartnerWorkstream {
  id           String @id @default(cuid())
  partnerId    String
  workstreamId String

  partner      Partner    @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  workstream   Workstream @relation(fields: [workstreamId], references: [id], onDelete: Cascade)

  @@unique([partnerId, workstreamId])
}

model PartnerInitiative {
  id           String @id @default(cuid())
  partnerId    String
  initiativeId String

  partner      Partner    @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  initiative   Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)

  @@unique([partnerId, initiativeId])
}

// ─── PERSON ────────────────────────────────────────────

model Person {
  id              String    @id @default(cuid())
  name            String
  initials        String?   // "DQ", "JC", etc.
  title           String?
  team            String?
  roleInProgram   String?
  userId          String?   @unique

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User?     @relation(fields: [userId], references: [id])
  assignments     Assignment[]
}

// ─── ASSIGNMENT ────────────────────────────────────────

model Assignment {
  id             String    @id @default(cuid())
  personId       String?
  userId         String?
  initiativeId   String
  month          String    // YYYY-MM
  hoursPlanned   Float     @default(0)
  hoursActual    Float     @default(0)
  notes          String?
  outcome        String?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  person         Person?    @relation(fields: [personId], references: [id])
  user           User?      @relation(fields: [userId], references: [id])
  initiative     Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
}

// ─── ARTIFACT / LINK ───────────────────────────────────

model Artifact {
  id            String    @id @default(cuid())
  initiativeId  String?
  partnerId     String?
  type          String    @default("DOC") // DOC | REPO | DASHBOARD | DEMO | OTHER
  title         String
  url           String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  initiative    Initiative? @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  partner       Partner?    @relation(fields: [partnerId], references: [id], onDelete: Cascade)
}
