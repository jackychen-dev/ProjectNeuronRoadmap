generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── USER & AUTH ───────────────────────────────────────

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  passwordHash   String?
  role           String    @default("MEMBER") // ADMIN | MEMBER
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  accounts       Account[]
  sessions       Session[]

  createdPrograms    Program[]      @relation("ProgramCreatedBy")
  createdWorkstreams Workstream[]   @relation("WorkstreamCreatedBy")
  createdInitiatives Initiative[]   @relation("InitiativeCreatedBy")
  createdMilestones  Milestone[]    @relation("MilestoneCreatedBy")
  createdPartners    Partner[]      @relation("PartnerCreatedBy")
  personProfile      Person?
  assignments        Assignment[]

  // Owner relations (subcomponent ownership)
  ownedInitiatives   Initiative[]   @relation("InitiativeOwner")
  authoredDocs       Documentation[]
  issueSeen          UserIssueSeen[]
  subTaskCompletionNotes SubTaskCompletionNote[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── PROGRAM ───────────────────────────────────────────

model Program {
  id              String    @id @default(cuid())
  name            String    // "Project Neuron" — this is an "Initiative" in the UI
  mission         String?   // rich text
  vision          String?   // rich text
  successTenets   String?   // rich text
  objectives      String?   // rich text
  fyStartYear     Int       @default(26)
  fyEndYear       Int       @default(28)
  status          String    @default("IN_PROGRESS") // NOT_STARTED | IN_PROGRESS | DONE
  startDate       DateTime?
  targetDate      DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdById     String?

  createdBy       User?           @relation("ProgramCreatedBy", fields: [createdById], references: [id])
  workstreams     Workstream[]
  burnSnapshots   BurnSnapshot[]
  docs            Documentation[] @relation("ProgramDocs")
}

// ─── WORKSTREAM ────────────────────────────────────────

model Workstream {
  id                   String    @id @default(cuid())
  programId            String
  name                 String    // display name
  slug                 String    // URL-safe key: connectors, kit-applications, etc.
  description          String?
  targetCompletionDate String?   // e.g. "November 2027"
  status               String    @default("IN_PROGRESS") // NOT_STARTED | IN_PROGRESS | DONE
  sortOrder            Int       @default(0)
  color                String?   // hex color for Gantt bars

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  createdById          String?

  program              Program   @relation(fields: [programId], references: [id], onDelete: Cascade)
  createdBy            User?     @relation("WorkstreamCreatedBy", fields: [createdById], references: [id])
  initiatives          Initiative[]
  partnerLinks         PartnerWorkstream[]
  openIssues           OpenIssue[]
  docs                 Documentation[] @relation("WorkstreamDocs")
}

// ─── INITIATIVE ────────────────────────────────────────

model Initiative {
  id                String    @id @default(cuid())
  workstreamId      String
  name              String
  description       String?
  category          String    @default("TOOLING")
  // CONNECTOR | KIT_APP | PORTAL | AI_SYSTEM | INFRA | DEVSECOPS | ROBOTICS | TOOLING
  plannedStartMonth String?   // YYYY-MM
  plannedEndMonth   String?   // YYYY-MM
  status            String    @default("NOT_STARTED")
  // NOT_STARTED | IN_PROGRESS | BLOCKED | DONE
  tags              String?   // comma-separated
  ownerInitials     String?   // e.g. "DQ", "JC", "AB" from PDF
  ownerId           String?   // FK to User — subcomponent owner
  needsRefinement   Boolean   @default(false)
  sortOrder         Int       @default(0)

  archivedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  createdById       String?

  workstream        Workstream @relation(fields: [workstreamId], references: [id], onDelete: Cascade)
  createdBy         User?      @relation("InitiativeCreatedBy", fields: [createdById], references: [id])
  owner             User?      @relation("InitiativeOwner", fields: [ownerId], references: [id])

  totalPoints       Int       @default(0) // total story points for this initiative

  milestones        Milestone[]
  partnerLinks      PartnerInitiative[]
  artifacts         Artifact[]
  assignments       Assignment[]
  subTasks          SubTask[]
  docs              Documentation[] @relation("InitiativeDocs")

  // Dependencies (many-to-many self)
  dependsOn         InitiativeDependency[] @relation("DependsOn")
  dependedBy        InitiativeDependency[] @relation("DependedBy")
}

// ─── SUB-TASK ─────────────────────────────────────────

model SubTask {
  id                String    @id @default(cuid())
  initiativeId      String
  name              String
  description       String?
  points            Int       @default(0)
  completionPercent Int       @default(0) // 0–100
  status            String    @default("NOT_STARTED") // NOT_STARTED | IN_PROGRESS | DONE
  sortOrder         Int       @default(0)
  assigneeId        String?   // FK to Person — who is working on this subtask
  assignedOrganization String?   // 'ECLIPSE' | 'ACCENTURE' — which org is assigned to this subcomponent

  // Story-point estimation inputs
  estimatedDays     Float?    // estimated effort in days
  unknowns          String?   // None | Low | Low–Moderate | High | Very High / Exploratory
  integration       String?   // Single system | 1–2 systems | Multiple internal systems | Cross-team / external dependency
  isAddedScope      Boolean   @default(false) // true = effort added after initial plan

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  initiative        Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  assignee          Person?    @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  openIssues        OpenIssue[]
  completionNotes   SubTaskCompletionNote[]
}

// ─── SUBTASK COMPLETION NOTE (reason + timestamp when % updated) ───
model SubTaskCompletionNote {
  id              String   @id @default(cuid())
  subTaskId       String
  previousPercent Int      // value before update
  newPercent      Int      // value after update
  reason          String   // comment/reason for the update
  createdAt       DateTime @default(now())
  userId          String?  // who wrote the comment (from their user account)

  subTask         SubTask  @relation(fields: [subTaskId], references: [id], onDelete: Cascade)
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  @@index([subTaskId])
}

// ─── OPEN ISSUE ──────────────────────────────────────

model OpenIssue {
  id              String    @id @default(cuid())
  workstreamId    String
  subTaskId       String?   // optional: the subtask this issue blocks
  title           String
  description     String?
  severity        String    @default("NOT_A_CONCERN") // STOPPING | SLOWING | NOT_A_CONCERN
  screenshotUrl   String?   // path or data-URL for uploaded screenshot
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  resolvedAt      DateTime? // null = open

  workstream      Workstream @relation(fields: [workstreamId], references: [id], onDelete: Cascade)
  subTask         SubTask?   @relation(fields: [subTaskId], references: [id], onDelete: SetNull)
  assignees       OpenIssueAssignee[]
  comments        IssueComment[]
  mentions        IssueMention[]
  userSeen        UserIssueSeen[]
}

model OpenIssueAssignee {
  id        String @id @default(cuid())
  issueId   String
  personId  String

  issue     OpenIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  person    Person    @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([issueId, personId])
}

// ─── ISSUE COMMENT ─────────────────────────────────

model IssueComment {
  id          String    @id @default(cuid())
  issueId     String
  parentId    String?   // for threaded replies
  body        String    // the comment text
  authorName  String?   // optional: who wrote it
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  issue       OpenIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  parent      IssueComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     IssueComment[] @relation("CommentReplies")
  mentions    IssueCommentMention[]
  issueMentions IssueMention[]  // back-relation for notification/seen tracking
}

// ─── ISSUE COMMENT MENTION (@people) ─────────────────

model IssueCommentMention {
  id         String   @id @default(cuid())
  commentId  String
  personId   String

  comment    IssueComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  person     Person       @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([commentId, personId])
}

model InitiativeDependency {
  id              String @id @default(cuid())
  initiativeId    String
  dependsOnId     String

  initiative      Initiative @relation("DependsOn", fields: [initiativeId], references: [id], onDelete: Cascade)
  dependsOn       Initiative @relation("DependedBy", fields: [dependsOnId], references: [id], onDelete: Cascade)

  @@unique([initiativeId, dependsOnId])
}

// ─── MILESTONE ─────────────────────────────────────────

model Milestone {
  id            String    @id @default(cuid())
  initiativeId  String?
  programId     String?   // for program-level milestones
  name          String
  date          String?   // YYYY-MM
  dateEnd       String?   // optional end for ranges
  notes         String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdById   String?

  initiative    Initiative? @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  createdBy     User?       @relation("MilestoneCreatedBy", fields: [createdById], references: [id])
}

// ─── PARTNER ───────────────────────────────────────────

model Partner {
  id              String    @id @default(cuid())
  name            String
  roleDescription String?
  agreements      String?
  logoUrl         String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdById     String?

  createdBy       User?     @relation("PartnerCreatedBy", fields: [createdById], references: [id])
  workstreamLinks PartnerWorkstream[]
  initiativeLinks PartnerInitiative[]
  artifacts       Artifact[]
}

model PartnerWorkstream {
  id           String @id @default(cuid())
  partnerId    String
  workstreamId String

  partner      Partner    @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  workstream   Workstream @relation(fields: [workstreamId], references: [id], onDelete: Cascade)

  @@unique([partnerId, workstreamId])
}

model PartnerInitiative {
  id           String @id @default(cuid())
  partnerId    String
  initiativeId String

  partner      Partner    @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  initiative   Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)

  @@unique([partnerId, initiativeId])
}

// ─── PERSON ────────────────────────────────────────────

model Person {
  id              String    @id @default(cuid())
  name            String
  initials        String?   // "DQ", "JC", etc.
  title           String?
  team            String?
  roleInProgram   String?
  userId          String?   @unique

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user                User?     @relation(fields: [userId], references: [id])
  assignments         Assignment[]
  assignedSubTasks    SubTask[]
  openIssueAssignments OpenIssueAssignee[]
  issueMentions       IssueCommentMention[]
  issueMentionSeen    IssueMention[]  // back-relation for @mention notification/seen
}

// ─── ASSIGNMENT ────────────────────────────────────────

model Assignment {
  id             String    @id @default(cuid())
  personId       String?
  userId         String?
  initiativeId   String
  month          String    // YYYY-MM
  hoursPlanned   Float     @default(0)
  hoursActual    Float     @default(0)
  notes          String?
  outcome        String?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  person         Person?    @relation(fields: [personId], references: [id])
  user           User?      @relation(fields: [userId], references: [id])
  initiative     Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
}

// ─── ARTIFACT / LINK ───────────────────────────────────

model Artifact {
  id            String    @id @default(cuid())
  initiativeId  String?
  partnerId     String?
  type          String    @default("DOC") // DOC | REPO | DASHBOARD | DEMO | OTHER
  title         String
  url           String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  initiative    Initiative? @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  partner       Partner?    @relation(fields: [partnerId], references: [id], onDelete: Cascade)
}

// ─── BURN SNAPSHOT ──────────────────────────────────────
// Date-stamped progress capture per Initiative (Program).
// The burndown chart is derived from these snapshots — no straight-line interpolation.

model BurnSnapshot {
  id              String   @id @default(cuid())
  programId       String
  date            String   // YYYY-MM — monthly period key
  totalPoints     Int
  completedPoints Int
  percentComplete Float
  workstreamData  Json?    // { [workstreamId]: { name, totalPoints, completedPoints } }

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  program         Program  @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, date])
}

// ─── DOCUMENTATION ──────────────────────────────────────
// Attachable to any entity: PROGRAM (Initiative), WORKSTREAM, INITIATIVE (Subcomponent)

model Documentation {
  id            String   @id @default(cuid())
  title         String
  body          String   @default("")
  entityType    String   // PROGRAM | WORKSTREAM | INITIATIVE
  programId     String?
  workstreamId  String?
  initiativeId  String?
  authorId      String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  author        User?        @relation(fields: [authorId], references: [id])
  program       Program?     @relation("ProgramDocs", fields: [programId], references: [id], onDelete: Cascade)
  workstream    Workstream?  @relation("WorkstreamDocs", fields: [workstreamId], references: [id], onDelete: Cascade)
  initiative    Initiative?  @relation("InitiativeDocs", fields: [initiativeId], references: [id], onDelete: Cascade)
}

// ─── USER ISSUE SEEN ────────────────────────────────────
// Tracks when a user last viewed an issue for notification badges.

model UserIssueSeen {
  id         String   @id @default(cuid())
  userId     String
  issueId    String
  lastSeenAt DateTime @default(now())

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  issue      OpenIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@unique([userId, issueId])
}

// ─── ISSUE MENTION ──────────────────────────────────────
// Tracks @mentions of people in issue comments.

model IssueMention {
  id         String    @id @default(cuid())
  issueId    String
  commentId  String
  personId   String
  createdAt  DateTime  @default(now())
  seenAt     DateTime? // null = unseen

  issue      OpenIssue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  comment    IssueComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  person     Person       @relation(fields: [personId], references: [id], onDelete: Cascade)
}
